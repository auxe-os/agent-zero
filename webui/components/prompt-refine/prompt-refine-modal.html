<!-- Prompt Refinement Modal Component -->
<div x-data="promptRefineModal"
     x-show="isOpen"
     x-cloak
     class="modal-overlay"
     @click.self="closeModal()"
     @keydown.escape.window="closeModal()">
    <div class="modal-container" @click.stop>
        <div class="modal-header">
            <h3 class="modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="modal-icon">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                Refine Your Prompt
            </h3>
            <button class="modal-close" @click="closeModal()" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="modal-content">
            <!-- Processing State -->
            <div x-show="isProcessing" class="processing-state">
                <div class="processing-spinner"></div>
                <p class="processing-text">Refining your prompt...</p>
                <p class="processing-subtitle">Analyzing and optimizing for Agent Zero</p>
            </div>

            <!-- Error State -->
            <div x-show="error" class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h4>Refinement Failed</h4>
                <p class="error-message" x-text="error"></p>
                <button class="retry-button" @click="retryRefinement()">Try Again</button>
            </div>

            <!-- Refinement Result -->
            <div x-show="!isProcessing && !error && refinedPrompt" class="refinement-result">
                <!-- Comparison Section -->
                <div class="comparison-section">
                    <div class="comparison-header">
                        <h4>Before & After Comparison</h4>
                        <div class="improvement-indicator">
                            <span class="improvement-count" x-text="improvementCount"></span>
                            <span class="improvement-text">improvements</span>
                        </div>
                    </div>

                    <div class="comparison-container">
                        <div class="prompt-column original">
                            <div class="prompt-header">
                                <h5>Original Prompt</h5>
                                <span class="prompt-length" x-text="originalLength + ' characters'"></span>
                            </div>
                            <div class="prompt-content original-content">
                                <pre x-text="originalPrompt"></pre>
                            </div>
                        </div>

                        <div class="arrow-separator">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 7l5 5-5 5"/>
                            </svg>
                        </div>

                        <div class="prompt-column refined">
                            <div class="prompt-header">
                                <h5>Refined Prompt</h5>
                                <span class="prompt-length" x-text="refinedLength + ' characters'"></span>
                            </div>
                            <div class="prompt-content refined-content">
                                <pre x-text="refinedPrompt"></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Improvements Section -->
                <div x-show="improvements.length > 0" class="improvements-section">
                    <h4>Improvements Made</h4>
                    <ul class="improvements-list">
                        <template x-for="improvement in improvements">
                            <li x-text="improvement"></li>
                        </template>
                    </ul>
                </div>

                <!-- Analysis Section -->
                <div x-show="analysis" class="analysis-section">
                    <h4>Analysis & Insights</h4>
                    <div class="analysis-content">
                        <div class="analysis-item">
                            <span class="analysis-label">Confidence Score:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" :style="`width: ${confidenceScore}%`"></div>
                                <span class="confidence-text" x-text="confidenceScore + '%'"></span>
                            </div>
                        </div>
                        <div x-show="agentProfileOptimized" class="analysis-item">
                            <span class="analysis-label">Agent Profile:</span>
                            <span class="agent-badge" x-text="agentProfile"></span>
                        </div>
                    </div>
                </div>

                <!-- Suggestions Section -->
                <div x-show="suggestions.length > 0" class="suggestions-section">
                    <h4>üí° Suggestions</h4>
                    <ul class="suggestions-list">
                        <template x-for="suggestion in suggestions">
                            <li x-text="suggestion"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer" x-show="!isProcessing && !error && refinedPrompt">
            <div class="footer-actions">
                <button class="secondary-button" @click="closeModal()">
                    Cancel
                </button>
                <button class="secondary-button" @click="editOriginal()">
                    Edit Original
                </button>
                <button class="primary-button" @click="acceptRefinement()">
                    Use Refined Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Prompt Refine Modal Component
function promptRefineModal() {
    return {
        isOpen: false,
        isProcessing: false,
        error: null,
        originalPrompt: '',
        refinedPrompt: '',
        improvements: [],
        suggestions: [],
        analysis: null,
        originalLength: 0,
        refinedLength: 0,
        improvementCount: 0,
        confidenceScore: 0,
        agentProfileOptimized: false,
        agentProfile: 'default',

        // Open modal with prompt
        openModal(prompt) {
            this.isOpen = true;
            this.originalPrompt = prompt;
            this.originalLength = prompt.length;
            this.error = null;
            this.refinedPrompt = '';
            this.improvements = [];
            this.suggestions = [];
            this.analysis = null;
            this.isProcessing = true;

            // Get current agent profile
            this.agentProfile = window.getCurrentAgentProfile?.() || 'default';

            // Start refinement process
            this.performRefinement(prompt);
        },

        // Close modal
        closeModal() {
            this.isOpen = false;
            this.resetState();
        },

        // Reset component state
        resetState() {
            this.isProcessing = false;
            this.error = null;
            this.originalPrompt = '';
            this.refinedPrompt = '';
            this.improvements = [];
            this.suggestions = [];
            this.analysis = null;
        },

        // Perform prompt refinement
        async performRefinement(prompt) {
            try {
                this.isProcessing = true;

                const response = await fetch('/api/prompt_refine', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': window.apiKey
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        context: window.getContext?.() || '',
                        agent_profile: this.agentProfile,
                        options: {
                            improve_clarity: true,
                            add_structure: true,
                            add_context: true,
                            suggest_tools: true,
                            add_examples: true,
                            add_specificity: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Set refined data
                this.refinedPrompt = data.refined_prompt;
                this.refinedLength = data.refined_prompt.length;
                this.improvements = data.analysis.improvements;
                this.improvementCount = data.analysis.improvements_count;
                this.suggestions = data.suggestions;
                this.analysis = data.analysis;
                this.confidenceScore = Math.round(data.analysis.confidence_score * 100);
                this.agentProfileOptimized = data.analysis.agent_profile_optimized;

            } catch (error) {
                console.error('Prompt refinement error:', error);
                this.error = error.message || 'Failed to refine prompt';
            } finally {
                this.isProcessing = false;
            }
        },

        // Retry refinement
        retryRefinement() {
            this.error = null;
            this.performRefinement(this.originalPrompt);
        },

        // Accept refined prompt
        acceptRefinement() {
            // Update chat input with refined prompt
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = this.refinedPrompt;
                // Trigger input event to update textarea height
                chatInput.dispatchEvent(new Event('input'));

                // Focus the input
                chatInput.focus();
            }

            // Show success notification
            this.showNotification('Prompt refined successfully!', 'success');

            // Close modal
            this.closeModal();
        },

        // Edit original prompt
        editOriginal() {
            // Update chat input with original prompt
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = this.originalPrompt;
                // Trigger input event to update textarea height
                chatInput.dispatchEvent(new Event('input'));

                // Focus the input
                chatInput.focus();
            }

            // Close modal
            this.closeModal();
        },

        // Show notification
        showNotification(message, type = 'info') {
            // Use existing notification system if available
            if (window.toast) {
                window.toast(message, type);
            } else {
                // Fallback notification
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
    }
}
</script>